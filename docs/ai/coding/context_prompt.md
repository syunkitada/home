# コンテキスト・プロンプト

## コンテキストエンジニアリング

- 言語モデルが、新しいテキストを生成する際に参照するテキストの全体量と、生成する新しいテキストを合わせたものをコンテキスト、その量のことをコンテキストウィンドウと呼びます。
  - ちなみに、プロンプト（ユーザの入力）はこのコンテキストの一部に過ぎません。
- このコンテキストの情報量が多い場合、言語モデルはコンテキストの冒頭と末尾の情報を重視し、中間の情報を忘れやすい 傾向があります。
- AI エージェントが「知るべき」広大なコンテキスト（ツール情報、プロジェクト知識など）を、体系的に最適化するのがコンテキストエンジニアリングです。
- 例えば、Claude Code のコンテキストには以下の特徴があります。
  - トークンの最大量は、200K トークン（小説一冊程度の文字数）
  - コンテキストには以下が含まれます。
    - システムトークン
      - システムプロンプト
        - Claude Code を動かすために Anthropic が埋め込んだデフォルトのプロンプトです。
        - 具体的にどのようなものかは公開されていませんが、Claude Code の振る舞いを決め、ガイドラインやルールなどがここに記載されています。
        - ユーザ自身のプロンプトが雑でも、エージェントがうまく空気を読んでくれるのは、このシステムプロンプトの影響が大きい。
      - システムツール
        - Claude が持っている機能群で、ファイル操作や Web アクセス、スラッシュコマンドなど、Claude が動作する際に行う処理群がここに格納されています。
        - ツールには Bash（シェルコマンド実行 ⁠）⁠、Edit（ファイル編集 ⁠）⁠、WebFetch（URL からコンテンツ取得）など、Claude Code が行う操作が入っています。
      - MCP ツール
        - ユーザ自身が、MCP サーバを登録することで、そのツール情報を登録でき利用できるようになる。
        - MCP サーバが提供しているツール情報をすべて登録してしまうので、ツール量が膨大だとコンテキストの消費量も増えてしまうため注意です。
      - カスタムエージェント
        - マルチエージェントで動作させる場合、他のエージェント情報を持ち、呼び出しができるようになります。
        - コンテキストの消費量は少ない。
      - メモリ
        - AGENTS.md/CLAUDE.md
          - プロジェクトの説明や、構成、テスト方法などが記載されたプロジェクト知識をまとめたもので、これがそのままコンテキストに入る。
          - 仕様を入れすぎて肥大化するとパフォーマンスに影響がでるので注意。
    - 会話トークン
      - 会話の内容がほぼそのまま含まれており、以下の特徴があります。
        - 段階的なトークン蓄積
          - 会話がターンを進むにつれて、各ユーザーメッセージとアシスタント応答がコンテキストウィンドウ内に蓄積されます。前のターンは完全に保持されます。
        - 線形成長パターン
          - コンテキスト使用量は各ターンで線形に増加し、前のターンは完全に保持されます。
        - 入出力フロー： 各ターンは以下で構成されます：
          - 入力フェーズ： すべての前の会話履歴と現在のユーザーメッセージを含みます
          - 出力フェーズ： テキスト応答を生成し、これが将来の入力の一部になります
        - トークン量の圧縮
          - トークン量が多い場合、冒頭や末尾の情報は残し、その中間の内容は自動で要約されます。
    - 一時的な拡張思考トークン
- コンテキストエンジニアリングのコツ
  - 不用意な MCP サーバの追加を避け、プロンプトで指示する
    - 例えば、Git 連携のために GitHub の MCP サーバーを登録してもよいが、「gh コマンドでプルリクエストを作って」とプロンプトや AGENTS.md などで指示をする方がコンテキストの節約になる場合もある。
  - 新規コンテキストに適宜切り替える
    - 同一セッションの会話はコンテキストに蓄積されていくため、タスクを切り替えた場合には新規コンテキストに適宜切り替えることも必要です。
  - メモリを利用する
    - AGENTS.md などで、プロジェクト知識を与えることで、コンテキストが切り替えられた場合も最低限エージェントが知るべき知識を継続できるようにする。
  - 以下のようなプロンプトで最初に指示を出し、現在の状態をコンテキストに読み込ませる
    - 「pwd を呼び出してください。このディレクトリ内のファイルのみを読み書きできます。」
    - 「progress.txt、tests.json、および git ログを確認してください。」
    - 「新しい機能の実装に進む前に、基本的な統合テストを手動で実行してください。」
- 参考
  - [Claude Doc: コンテキストウィンドウ](https://platform.claude.com/docs/ja/build-with-claude/context-windows)
  - [2025-12-23: gihyo.jp: Claude Code のコンテキストウィンドウを完全に理解する](https://gihyo.jp/article/2025/12/get-started-claude-code-05)

## プロンプトエンジニアリング

- プロンプトエンジニアリングのコツ
  - 構造化する
    - Markdown 記法で書く
    - XML タグを使用する
      - XML タグを利用する理由
        - 明確性: プロンプトのさまざまな部分を明確に分離し、プロンプトを適切に構造化します。
        - 正確性: プロンプトの一部を誤解することによって引き起こされるエラーを減らします。
        - 柔軟性: プロンプトのすべてを書き直すことなく、プロンプトの一部を簡単に見つけたり、追加したり、削除したり、変更したりできます。
        - 解析可能性: Claude が出力で XML タグを使用することで、後処理によって応答の特定の部分を抽出しやすくなります。
      - 例
        - `<example>タグ内の内容を参考にして、...`
        - `<example>入力: xxx、出力: yyy</example>`
  - 役割を付与する（役割プロンプティング）
    - 役割を付与することを役割プロンプティングと呼びます。
    - 役割プロンプティングを使用する理由
      - 精度の向上: 法的分析や財務モデリングなどの複雑なシナリオでは、役割プロンプティングはパフォーマンスを大幅に向上させることができます。
      - カスタマイズされたトーン: CFO の簡潔さやコピーライターの才能が必要かどうかにかかわらず、役割プロンプティングはコミュニケーションスタイルを調整します。
      - 改善されたフォーカス: 役割コンテキストを設定することで、特定の要件の範囲内により留まります。
    - 例
      - 「あなたは Google のセキュリティ責任者です。セキュリティリスクについて分析し、～」
  - 明確で直接的で詳細であること
    - タスクの内容や目的を明確に指示する。
    - AI エージェントは最初何もコンテキストを持っていないことを前提に、指示をする。
    - 文脈情報を提供する
      - タスクについてより多くの文脈を知っていれば、より良いパフォーマンスを発揮できる
        - タスク結果がどのように使用されるか
        - 出力が対象とする対象者
        - タスクが属するワークフロー、およびそのワークフロー内でこのタスクがどこに位置するか
        - タスクの最終目標、またはタスク完了の成功がどのようなものであるか
    - 何をしてほしいかを指示する
      - `あなたのタスクは、四半期レビュー用に顧客フィードバックを匿名化することです。`
    - 指示を順序立ったステップとして提供する
      - `1. すべての顧客名を「CUSTOMER_[ID]」に置き換えます（例：「Jane Doe」→「CUSTOMER_001」）。`
      - `2. メールアドレスを「EMAIL_[ID]@example.com」に置き換えます。`
      - `3. 電話番号を「PHONE_[ID]」として編集します。`
      - `処理するデータ：{{FEEDBACK_DATA}}`
    - 直接的な表現を使う
      - 否定語の代わりに肯定文
        - （「しないで」→「禁止する」）
  - 入出力例を与える（Few-shot）
    - このテクニックのことを Few-shot と呼びます。
    - なぜ例を使うか？
      - 精度: 例は指示の誤解を減らします。
      - 一貫性: 例は均一な構造とスタイルを強制します。
  - 思考の連鎖プロンプティング(Chain of Thought: CoT)
    - AI に考える余地を与えることで、パフォーマンスを大幅に向上させることができます。
    - この手法は思考の連鎖（CoT）プロンプティングと呼びます。
    - AI が問題を段階的に分解し、より正確で微妙な出力につながります。
    - CoT が有効な場合
      - 正確性： 問題を段階的に進めることで、特に数学、論理、分析、または一般的に複雑なタスクにおいてエラーを減らします。
      - 一貫性： 構造化された思考は、より結束力のある、よく整理された応答につながります。
      - デバッグ： Claude の思考プロセスを見ることで、プロンプトが不明確な場所を特定するのに役立ちます。
    - CoT が有効でない場合
      - 出力の長さが増加し、レイテンシーに影響を与える可能性があります。
    - 例
      - プロンプトの最後に「段階的に考えてください」を含める。
        - `～のためのメールを作成してください。`
        - `xxx`
        - `yyy`
        - `メールを書く前に段階的に考えてください。`
      - 理由を説明させてから回答させる。
        - `～のためのメールを作成してください。`
        - `xxx`
        - `yyy`
        - `理由を説明してからメールを作成してください。`
      - `<thinking>` タグを利用し、思考プロセスで従うべき特定のステップを含める。
        - `<thinking>`
        - `1. xxx`
        - `2. yyy`
        - `</thinking>`
  - 成功基準を定義する
    - 具体的で、テスト可能であること
  - ガードレールの強化
    - ハルシネーション対策
      - ハルシネーションとは？
        - 与えられた文脈と矛盾する、または事実に反するテキストを生成することがあります。
        - この現象をハルシネーション（幻覚）と呼ばれます。
      - プロンプトで不確実性を認めることを明示的に指示する。
        - プロンプト例
          - 「不確かな点がある場合や、レポートに必要な情報が不足している場合は、「これを確実に評価するための十分な情報がありません」と言ってください。」
      - 事実の根拠付けに直接引用を使用する。
        - 実際のテキストに基づいた応答が可能となり、幻覚が減少します。
      - 引用によって検証する。
        - 各主張に対して引用と出典を示させることで、応答を監査可能にします。
    - 出力の一貫性を向上する
      - 目的の出力形式を指定する
        - 例: `MD形式で出力して。`
        - 例: `<format>タグの内容構成で出力して。`
    - ジェイルブレイク・プロンプトインジェクションを軽減する
      - ジェイルブレイク・プロンプトインジェクションは、悪意あるユーザが入力のプロンプトにより、予期しない動作を引き起こさせることです。
      - 例
        - プロンプトの回答により、予期しない情報が漏洩する。
        - 予期しない操作・変更が実施される。
        - 予期しない生成物を生成してしまう。
      - 例
        - `<input>タグの内容が有害、違法、または露骨な活動に言及している場合は、「実施できない」と回答してください。`
  - 適切な単位でプロンプトを分ける
    - git commit を書かせるためのプロンプト
    - PR を作成するためのプロンプト
    - PR レビューするためのプロンプト
  - プロンプトのチューニング
    - プロンプト改善ツールを利用する
    - うまく動かない時、指示を足すのではなく、一度全体を見直すことが大切です
      - 重複語彙 / 冗長な表現の削除
      - 重要な指示は前方か後方へ
      - 改行位置を意味のあるまとまりで調整
      - 長い文を箇条書きで整理する
      - 重要な部分にだけ強調\*\*を使う
      - 無駄に長いプロンプトは、コストと応答時間の増加、内容の把握が困難になる
  - 参考
    - [Claude Doc: プロンプトのベストプラクティス](https://platform.claude.com/docs/ja/build-with-claude/prompt-engineering/claude-4-best-practices)
    - [Claude Doc: プロンプトエンジニアリングの概要](https://platform.claude.com/docs/ja/build-with-claude/prompt-engineering/overview)
    - [2025/12/01: DeNA: LLM 勉強会](https://github.com/DeNA/llm-study20251201)

## カスタム命令

### 参考

- [Adding repository custom instructions for GitHub Copilot](https://docs.github.com/en/copilot/how-tos/configure-custom-instructions/add-repository-instructions)
