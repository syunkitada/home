# Monitoring
* Googleであれどこであれ、モニタリングはプロダクション環境でやるべきことの中で絶対に欠かせない要素です
* サービスをモニタリングしていなければ、何が起きているかを知ることができず、何が起きているのかが見えていなければ、信頼性を保つことはできません


## Four Golden Signals
* latency
* traffic
* errors
* saturation


## 監視の全体像
* 監視対象ごとの切り口(行)、監視目的ごとの切り口(列)で見る
| 種類 | 稼働監視 | エラー監視 | 性能監視 |
| --- | --- | --- | --- |
| サービス(外部)監視 | ++ | -  | +  |
| リソース監視       | +  | -  | ++ |
| プロセス監視       | ++ | -  | -  |
| ログ監視           | -  | ++ | ++ |


### サービス（外部)監視
* 外部からサービスが適切に動いているかを実際に叩いてサービスの稼働状態を監視する
* また、Latencyから性能面も監視できる

### リソース監視
* プロセス数監視や、リソース枯渇は、サービス稼働に影響を及ぼすため、稼働監視も含んでいる
* メモリやIO, CPUなどのリソースがサチってないか監視する
    * ロードアベレージが詰まると性能が悪化する
    * メモリフルになるとswap in/out により性能が悪化や、OOM killされる
    * ディスクIO、ネットワークIOがフルになると、IO waitが増える

### プロセス監視
* プロセスが稼働しているか、していないかの監視

### ログ監視
* ログの中身(メッセージ/ステータスコード)からエラーを監視
    * アプリのログだけでなく、dmesgやraidのシステムエラーなども重要
* ログからレスポンスタイムとURIを記録し、性能を監視
* Slow Queryなどを記録し、性能を監視


## 方法論
### サービス（外部)監視
* 監視システム
    * 自作あるのみ
        * どうしてもサービス固有なものとなるので、自作するしかない
* 監視項目
    * ping疎通とlatency
    * curl(healthcheck用のパスで)疎通とlatency
    * サービス独自のワークフローの実行と、その処理時間(latency)
    * latencyを評価して、SLAを満たしているか

### リソース監視
* 監視システム
    * Sensu
    * Prometheus
    * TICK
    * ElasticSearch
* 監視項目

### プロセス監視
* 監視システム
    * Sensu
    * Prometheus
    * TICK
    * ElasticSearch
* 監視項目

### ログ監視
* 監視システム
    * ElasticSearch
* 監視項目


## 参考
* [NewRelic / Elasticsearch ではじめるSREに必要な性能監視入門](https://speakerdeck.com/katsuhisa91/elasticsearch-dehazimerusrenibi-yao-naxing-neng-jian-shi-ru-men)
