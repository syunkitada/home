# SMTP, POP, IMAP


## Contents
| Link | Description |
| --- | --- |
| [SMTPとPOP3とIMAP4](#SMTPとPOP3とIMAP4) | STMP, POP3, IMAP4を踏まえ、メール送受信の仕組みについて |
| [WebメールとIMAP](#WebメールとIMAP)     | Webメールについて |
| [用語メモ](#用語メモ)                   | ただの用語メモ |


## SMTPとPOP3とIMAP4
* SMTP=Simple Mail Transfer Protocol
    * メールサーバにメールを送信するためのプロトコル
    * ポート番号は25、サブミッションポートとして587も利用可能
    * SMTP over SSLのポート番号は465
* POP3=Post Office Protocol version 3
    * メールサーバからメールを受信するためのプロトコル
        * メールはメールクライアントソフトに保存され、振り分けなどの処理を行う
    * ポート番号は110
    * POP over SSLのポート番号は995
* IMAP4=Internet Message Access Protocol version 4
    * メールサーバからメールを参照するためのプロトコル
        * メールはサーバ側に保存され、振り分けなどの処理も行ってくれる
        * メールクライアント側の消費リソースが少なくて済むため、スマホなどで利用される
    * ポート番号は143
    * IMAP over SSLのポート番号は993
* 2つの使われ方がある
    * 一般ユーザがメールクライアントを利用して、SMTPサーバにメールデータを送信する
    * SMTPサーバから別のSMTPサーバに対してメールデータを送信する
* シンプルなメール送受信処理の流れ
    * メール送信者はSMTPを使ってSMTPサーバにメールを送る
    * メール受信者はPOP3やIMAP4を利用してPOP3サーバ(もしくはIMAP4サーバ)からメールを受け取る
    * このとき、メール送信者とメール受信者が利用するメールサーバは同一でないといけない(@以降のドメイン部分が一緒である必要がある)
    * また、基本的にSMTPサーバ、POP3サーバ、IMAP4サーバは同居しており、これらを合わせてメールサーバと呼ぶ
    * メール送信者とメール受信者のドメインが違う場合
        * メール送信者はSMTPを使って自身の設定しているメールサーバにメールを送る
        * そのメールサーバは、SMTPで目的のドメインのメールサーバにメールを転送する
        * そして、メール受信者は自身の設定しているメールサーバからPOP3でメールを受信する
* メール送信処理の流れ
    * メールクライアントは、メールクライアントに設定されているSMTPサーバにSMTP接続する
        * 認証の仕組み(SMTP-AUTH)
            * SMTPサーバに接続すると、サーバからは認証情報要求をされるので、メールクライアントはID・パスワードを送付する
            * SMTPサーバは、LDAPなどで受信したアカウントが正しいかを確認する
        * 認証の歴史
            * 認証がなかった時代は、みなが好き勝手にメールを送れたため、スパムメールが流行した
            * その対策としてPOP before SMTP(POPは認証機能がついてるので、SMTPをする前にPOPで認証していた)
            * その後、SMTP-AUTHが主流となった
    * 認証が成功したら、メールソフトからSMTPサーバにメールが送信される
    * SMTPサーバは自身のドメイン宛てであれば自身のメールスプールサーバに保存し、そうでなければ目的のドメインへのSMTPサーバへ転送する
        * 最後に、メール受信者は、POP3やIMAP4でメールスプールサーバからメールを受信する
    * 他のSMTPサーバへの転送の流れ
        * SMTPサーバはDNSサーバへMXレコードを問い合わせる
            * SMTPサーバはメールを受信したら、宛先メールアドレスの@以降のドメインネームのMXレコードをDNSサーバに問い合わせる
                * これにより、宛先メールアドレスのメールサーバのIPアドレスを取得できる
        * そのIPアドレス宛てにSMTPでメールを転送する
        * このとき、メールを受け取った側のSMTPサーバは、送り元のSMTPサーバのMXレコード、逆引きレコードをDNSサーバに問い合わせ、送り元が正しいか検証する
* メール受信処理の流れ
    * メールクライアントは、メールクライアントに設定されているメールスプールサーバ(POPサーバ、もしくはIMAPサーバ)のIPアドレスにメールの受信要求とアカウントのIDパスワード情報を送る
    * メールスプールサーバは、LDAPなどでアカウントの認証を行い、認証がとおれば、メールを受信できる


## WebメールとIMAP
* WebメールとはWebブラウザなどから利用できるメールのこと
* Webサーバは、ユーザにメールクライアントのWebUIを提供している
* Webサーバの裏ではメールサーバに対してIMAPでメール参照したり、SMTPでメールを送信している


## 用語メモ
* メールクライアントのことをMUA(Mail User Agent)と呼ぶ
* メールサーバのことをMTA(Mail Transfer Agent)と呼ぶ
