# メモリ(ハードウェア)

## 規格

- [DDR4](https://ja.wikipedia.org/wiki/DDR4_SDRAM)

## 物理メモリ

- L1 キャッシュでのアクセスミスは数 10 クロックのペナルティが生じる
- L2 キャッシュでのアクセスミスは数 10 バスクロックのペナルティが生じる
- キャッシュに読み込まれるタイミング
  - アプリケーションが参照したメモリの内容がキャッシュにない場合
  - アプリケーションがメモリに書き込みを行った内容がキャッシュにない場合
  - アプリケーションがプリフェッチ命令を実行した場合
  - ハードウェア・プリフェッチャーが動作した場合
- 読み込み書き込みの最小単位はキャッシュライン（64 バイト）

- バンド幅
- ストライド幅
  - チャンクサイズ／ブロックサイズ(4KB)
- ストライプ幅
  - データディスク数 × ストライド
- レイテンシ

## 用語

- DIMM
  - Dual Inline Memory Module
  - 自作 PC でよく使われるメモリモジュール
- SO-DIMM
  - Small Out DIMM
  - 大きさが DIMM の半分くらい
  - ノートパソコンなどの省スペースな機器で使われる
- DRAM
  - Dynamic Random Access Memory
  - 揮発性で、SRAM に比べてリフレッシュのために常に電力を消費することが欠点だが、大容量を安価に提供されている
  - DRAM チップとして DIMM にパッケージングされる
    - DIMM に DRAM が 8 個とか、裏面も利用して 16 個とかついている
  - SDRAM
    - Synchronous Dynamic Random Access Memory
    - システムバスに同期して動作する DRAM
    - SDRAM のインタフェースは同期式であり、制御入力に応答する前にクロック信号を待つため、コンピュータのシステムバスに同期して動作する
    - クロックは入ってくる命令をパイプライン化する内部の有限状態機械を駆動するのに使われる
      - そのため SDRAM のチップは非同期 DRAM よりも複雑な操作パターンを持つことができ、より高速に動作できる。
- Rank
  - DIMM は基本的に 64bit のバス幅を持っており、CPU やチップセットのメモリコントローラと 64bit 単位でデータのやり取りを行う
  - 1 枚の DIMM に 64bit になる DRAM のグループが一つあれば 1Rank、2 つあれば 2Rank となる
  - メモリコントローラは Rank ごとにやり取りを行うので、2Rank メモリでは電気的には 2 枚のメモリが刺さってることになる
    - メモリコントローラまでの速度が下がる、搭載できる枚数が減るなどの制約が発生する場合がある
  - メモリの速度は搭載枚数と、Rank によって変わってくる
    - 2DIMM の場合、Rank1 だと 2,667MHz、Rank2 だと 2,400MHz
    - 4DIMM の場合、Rank1 だと 2,133MHz、Rank2 だと 1,866MHz
  - 参考: [Ryzen で話題になった、メモリの”Rank”って何のことと?](https://pc.watch.impress.co.jp/docs/column/century_micro/1053794.html)
- DRAM の構成(4GB の例)
  - 512Mb \* 8 構成では、一つの DRAM は 512Mb のセルアレイが 8 つからなっている
  - 512Mb のセルアレイは 512M 個の 1bit のセルからなっていて、このセルに対して行と列を指定することで、DRAM にデータを読み書きしている
  - この DRAM が DIMM の片面に 8 つ搭載されて、512Mb _ 8bit _ 8 個 = 4GB となる
  - バス幅も 8bit \* 8 個なので 64bit = Rank1 となる
- SPD
  - Serial Presence Detect
  - PC やサーバーを起動するさいに、メモリモジュールの情報を BIOS に伝える規格/仕組み
  - SPD データ(メモリモジュールの情報)
    - メーカ名、規格、容量、搭載 DRAM(CHIP)の情報(メーカー名・規格・bit 構成・容量)、動作クロック周波数、CAS Latnecy(Column Address Strobe Latency)、動作電圧、ECC(誤り訂正符号)などのが含まれる
  - SPD データは EEPROM(Electrically Erasable Programmable Read Only Memory)と呼ばれるモジュールに保存される
    - ライトプロテクトの機能が搭載されている
    - データの書き換えには専用の機器が必要
  - 参考: [メモリモジュールに"SPD"という情報があるのを知っていますか?](http://pc.watch.impress.co.jp/docs/column/century_micro/1076466.html)
- ビットクロス
  - 新製品(DRAM)のビット当たりの単価が、従来品(DRAM)の単価を下回ること
  - ビットクロスするのとほぼ同時期に出荷量も逆転し、新旧世代交代となる
- ワード線・ビット線
  - ワード線は 2 次元状に並んだメモリーセルアレイの中から一列を選択するための制御信号線
  - メモリーセルは、ワード線とビット線の交点に置かれており、読み出し/書き込みを行なうアドレスに対応するワード線の電圧を上げることで、書き込み/読み出しが可能になる

## コマンド

```
# 搭載メモリ情報を表示する
$ sudo dmidecode -t memory
```

## 記事

- 2017/09/29 (サーバー/ハイエンド PC の主記憶を変革する NVDIMM 技術](http://pc.watch.impress.co.jp/docs/column/semicon/1083346.html)
- 2011/11/18 [次世代 DRAM 規格「DDR4」と新技術規格「3DS」の概要を公表- Server Memory Forum 2011](http://www.kumikomi.net/archives/2011/11/rp49serv.php?page=2)
