# ネットワークの Bonding

## サーバサイドでの Bonding(チーミングとも言う)

- balance-rr (0)
  - 送信の分散：ラウンドロビンで分散
  - 受信の分散：スイッチに依存
  - スイッチの制約：スイッチで EtherChannel を構成する必要がある
- active-backup (1)
  - 送信の分散: アクティブな NIC のみを利用
  - 受信の分散: アクティブな NIC のみを利用
  - スイッチの制約: なし
- balance-xor (2)
  - 送信の分散：MAC アドレスに基づいたハッシュで分散
    - ルータ越しだと常に同じアダプタ
    - ハッシュのポリシーは変更できる
  - 受信の分散：スイッチに依存
  - スイッチの制約：スイッチで EtherChannel を構成する必要がある
- broadcast (3)
  - すべての送信は、すべての NIC で行われる
- 802.3ad (4)
  - 送信の分散：MAC アドレスに基づいたハッシュで分散
    - ルータ越しだと常に同じアダプタ
    - ハッシュのポリシーは変更できる
  - 受信の分散：スイッチに依存
  - スイッチの制約：スイッチで 802.3ad を構成する必要がある
- balance-tlb (5)
  - 送信の負荷分散：負荷に応じてアダプタを選択
  - 受信の負荷分散：アクティブなアダプタのみ
    - アクティブなアダプタが故障すると別のアダプタが MAC アドレスを引き継ぐ
  - スイッチの制約：なし
- balance-alb (6)
  - 送信の負荷分散：負荷に応じてアダプタを選択
  - 受信の負荷分散：負荷に応じてアダプタを選択
    - 通信相手の ARP テーブルを書き換えることでアダプタを選択（ARP ネゴシエーション）
    - ルータ越しだと常に同じアダプタ
  - スイッチの制約：なし

## LAG(Link Aggregation)

- 複数の物理リンクを束ねて 1 つの論理リンクとして扱うことのできる技術のこと
- IEEE802.3ad で標準化され、Cisco では EtherChannel という用語を使用している
- 設定方法は 2 つ
  - スタティックにスイッチに設定する方法
  - 各スイッチポートで論理グループを作成して、LACP(Link Aggregation Control Protocol)を使用してスイッチ間でネゴシエーションして動的に ON にする方法
    - LACP は、IEEE802.3ad の標準プロトコル

## vPC

- Cisco の物理的に異なる 2 つの物理スイッチ間をポートチャネルで接続する技術
- vPC を利用すると、STP によるブロッキングによって片方リンクを無効化する必要がなくなる
- vPC 用語
  - vPC
    - vPC ピアスイッチによって形成されたポートチャネル
  - vPC ピアスイッチ
    - vPC プロトコルを実行し、vPC を提供するお互いの機器
  - vPC メンバポート
    - vPC を設定した vPC ピアスイッチ上の物理ポート
  - vPC ピアリンク
    - vPC ピアスイッチ間のポートチャネル
    - vPC ピアスイッチ間で同期のために使用されるリンク
    - ピアリンクを使用してローカルピアからの発信パケットとしてタグ付けする
    - 対向の vPC ピアスイッチの vPC メンバーポートの障害発生時に、データトラフィックを導く
  - vPC ピアキープアライブリンク
    - リモートピアが正常に動作しているかどうかを判別する"セカンダリテスト"として使用される
    - L3 通信パスを提供する
    - このリンクではデータトラフィックや同期トラフィックは送信されない
  - vPC ドメイン
    - vPC を構成する 2 台の vPC ピアスイッチが所属するドメインのこと
  - Cisco Fabric Services(CFS)
    - ステートフルな設定メッセージの送受信と同期をサポートするよう設計されたプロトコル
    - vPC ピアリンクでやりとりされる
    - vPC ピアスイッチ間の状態の同期（MAC テーブル等）を行う
