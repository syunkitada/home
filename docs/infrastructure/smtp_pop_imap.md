# SMTP, POP, IMAP

## Contents

| Link                                                              | Description                                              |
| ----------------------------------------------------------------- | -------------------------------------------------------- |
| [SMTP と POP3 と IMAP4](#smtp%E3%81%A8pop3%E3%81%A8imap4)         | STMP, POP3, IMAP4 を踏まえ、メール送受信の仕組みについて |
| [Web メールと IMAP](#web%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%A8imap) | Web メールについて                                       |
| [用語メモ](#%E7%94%A8%E8%AA%9E%E3%83%A1%E3%83%A2)                 | ただの用語メモ                                           |

## SMTP と POP3 と IMAP4

- SMTP=Simple Mail Transfer Protocol
  - メールサーバにメールを送信するためのプロトコル
  - ポート番号は 25、サブミッションポートとして 587 も利用可能
  - SMTP over SSL のポート番号は 465
- POP3=Post Office Protocol version 3
  - メールサーバからメールを受信するためのプロトコル
    - メールはメールクライアントソフトに保存され、振り分けなどの処理を行う
  - ポート番号は 110
  - POP over SSL のポート番号は 995
- IMAP4=Internet Message Access Protocol version 4
  - メールサーバからメールを参照するためのプロトコル
    - メールはサーバ側に保存され、振り分けなどの処理も行ってくれる
    - メールクライアント側の消費リソースが少なくて済むため、スマホなどで利用される
  - ポート番号は 143
  - IMAP over SSL のポート番号は 993
- 2 つの使われ方がある
  - 一般ユーザがメールクライアントを利用して、SMTP サーバにメールデータを送信する
  - SMTP サーバから別の SMTP サーバに対してメールデータを送信する
- シンプルなメール送受信処理の流れ
  - メール送信者は SMTP を使って SMTP サーバにメールを送る
  - メール受信者は POP3 や IMAP4 を利用して POP3 サーバ(もしくは IMAP4 サーバ)からメールを受け取る
  - このとき、メール送信者とメール受信者が利用するメールサーバは同一でないといけない(@以降のドメイン部分が一緒である必要がある)
  - また、基本的に SMTP サーバ、POP3 サーバ、IMAP4 サーバは同居しており、これらを合わせてメールサーバと呼ぶ
  - メール送信者とメール受信者のドメインが違う場合
    - メール送信者は SMTP を使って自身の設定しているメールサーバにメールを送る
    - そのメールサーバは、SMTP で目的のドメインのメールサーバにメールを転送する
    - そして、メール受信者は自身の設定しているメールサーバから POP3 でメールを受信する
- メール送信処理の流れ
  - メールクライアントは、メールクライアントに設定されている SMTP サーバに SMTP 接続する
    - 認証の仕組み(SMTP-AUTH)
      - SMTP サーバに接続すると、サーバからは認証情報要求をされるので、メールクライアントは ID・パスワードを送付する
      - SMTP サーバは、LDAP などで受信したアカウントが正しいかを確認する
    - 認証の歴史
      - 認証がなかった時代は、みなが好き勝手にメールを送れたため、スパムメールが流行した
      - その対策として POP before SMTP(POP は認証機能がついてるので、SMTP をする前に POP で認証していた)
      - その後、SMTP-AUTH が主流となった
  - 認証が成功したら、メールソフトから SMTP サーバにメールが送信される
  - SMTP サーバは自身のドメイン宛てであれば自身のメールスプールサーバに保存し、そうでなければ目的のドメインへの SMTP サーバへ転送する
    - 最後に、メール受信者は、POP3 や IMAP4 でメールスプールサーバからメールを受信する
  - 他の SMTP サーバへの転送の流れ
    - SMTP サーバは DNS サーバへ MX レコードを問い合わせる
      - SMTP サーバはメールを受信したら、宛先メールアドレスの@以降のドメインネームの MX レコードを DNS サーバに問い合わせる
        - これにより、宛先メールアドレスのメールサーバの IP アドレスを取得できる
    - その IP アドレス宛てに SMTP でメールを転送する
    - このとき、メールを受け取った側の SMTP サーバは、送り元の SMTP サーバの MX レコード、逆引きレコードを DNS サーバに問い合わせ、送り元が正しいか検証する
- メール受信処理の流れ
  - メールクライアントは、メールクライアントに設定されているメールスプールサーバ(POP サーバ、もしくは IMAP サーバ)の IP アドレスにメールの受信要求とアカウントの ID パスワード情報を送る
  - メールスプールサーバは、LDAP などでアカウントの認証を行い、認証がとおれば、メールを受信できる

## Web メールと IMAP

- Web メールとは Web ブラウザなどから利用できるメールのこと
- Web サーバは、ユーザにメールクライアントの WebUI を提供している
- Web サーバの裏ではメールサーバに対して IMAP でメール参照したり、SMTP でメールを送信している

## 用語メモ

- メールクライアントのことを MUA(Mail User Agent)と呼ぶ
- メールサーバのことを MTA(Mail Transfer Agent)と呼ぶ
