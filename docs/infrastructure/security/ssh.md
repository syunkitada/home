# SSH

## SSHv2

- SSH サーバ接続後の流れ
- 接続後、サーバとクライアントの間で SSH バージョン文字列を交換し，SSHv1 で接続するか，SSHv2 で接続するかを決定する
- その後、使用できる鍵交換方式、希望する公開鍵暗号方式、共通鍵暗号方式、メッセージ認証コード、圧縮アルゴリズムのリストを交換する
- このリストから、使用するアルゴリズムを決定し、Diffie-Hellman 鍵交換方式で暗号化通路に使用する共通鍵を交換する
  - Diffie-Hellman 鍵方式は、交換するカギを直接送ることなく、両者で鍵を共有できるアルゴリズム
- 共通鍵の交換中に、サーバのホスト公開鍵を、クライアントで保持しているホスト公開鍵のデータベースと照合して、ホスト認証もする
  - 新規のホストであれば、データベースに登録するかを尋ねられ、クライアント側で登録を許可する必要がある
  - データベースに登録済みであるホストであれば認証済みとする
  - データベースに登録済みだが、公開鍵が異なっていた場合は不正なホストとみなして接続を停止する
    - サーバを再インストールなどでホスト公開鍵を作り直した場合には、ssh-keygen -R [hostname] などでデータベースからいったんホスト情報を消す必要がある
- 共通鍵を交換し終わったら、暗号化通信路を確立し、以降の通信は暗号化通信路で行われる
- ユーザ認証を以下のどちらかで行う
  - 公開鍵認証
    - 各ユーザは自分の公開鍵・秘密鍵のペアを作っておく
    - 各ユーザは自分の公開鍵をサーバ上になんらかの方法で以下に保存しておく
      - /home/[user]/.ssh/authorized_keys
    - 認証には電子署名を使う
      - ユーザ名、ユーザの公開鍵、ユーザの公開鍵アルゴリズムを記述した認証要求メッセージを作成する
      - この認証要求メッセージに対して、ユーザの秘密鍵を使用して電子署名を作成する
        - 秘密鍵を作成する際にパスフレーズを設定してる場合は、この時にパスフレーズを要求される
      - サーバに認証要求メッセージと電子署名を送信する
        - これを ssh-agent に登録しておくことで、別ホストに ssh するさいにいちいちパスフレーズ入力をする必要がなくなる
        - また、agent 転送することで多段 ssh が楽になる
      - サーバは、認証要求メッセージに含まれるユーザ名、ユーザの公開鍵が、登録済みのユーザ名、公開鍵であることを確認する
      - サーバは、登録されているユーザの公開鍵を使用して、送付された電子署名を審査し、正しいユーザの電子署名であることを確認できると、ユーザ認証成功とする
  - パスワード認証(非推奨)
    - ログインユーザのローカルパスワードによって認証する
    - パスワードは暗号化通信路でやり取りされるので、第三者による観測はできない
    - パスワードが漏洩しなければ問題ないが、パスワードが漏洩した場合にローカルパスワードも漏洩したこととなる
    - このユーザが sudo password を利用していた場合、ssh されるだけでなく、root 権限の操作も可能となってしまう
    - 多段 ssh もできないので不便（やりようによってはできるが、、、
- ユーザ認証が成功したら、ターミナルのセッションが開始される
