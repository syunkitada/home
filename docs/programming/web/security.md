# Security

## XSS と出力エンコーディング

- XSS とは、不正なスクリプト(基本的に JavaScript)をページ内に仕込む攻撃
- 対策として、ページ上に出力する変数値を全て無害な文字列にエンコードする

## SQL インジェクション

- リクエストから受け取った値をそのまま SQL クエリに利用した場合などに、SQL クエリ内に不正なクエリを仕込むことができる
- このような不正な SQL クエリを実行させる攻撃を SQL インジェクションと呼ぶ
- 対策として、SQL クエリに渡される変数値をすべて無害な文字列にエンコードする

## CSRF

- 対策をしていないと自サイトではない他のサイトのフォームからも、自サイトのアドレスを指定されていれば POST などのリクエストが行えてしまう
- また、クッキーなどでログイン管理していても、自サイトへの投稿は自サイト用のクッキーが扱われるので、 クッキーにログイン情報が残っている場合、投稿できてしまう
- このような不正なフォームなどからのリクエストを CSRF(クロスサイト・リクエスト・フォージェリ)と言う
- 自サイトのフォームにトークンを仕込むことで、自サイトのフォーム以外からの不正なリクエストを受け付けないようにできる

## Session

- Session は、ユーザごとにキーバリューの値を保存して扱うためのもの
- ユーザのログイン情報管理などに利用されることが多い
- Cookie にセッション ID を暗号化して保存しておき、サーバサイドでもセッション ID に紐ずくユーザ・ログイン情報などを保存しておく
- ユーザから送られてくるサーバは Cookie を見て、ログイン済みなら専用ページを見せたり、ログインしてないならログインページへリダイレクトしたりする

## Cookie

- secure 属性: HTTPS 上での通信でのみ Cookie を扱うようになる
- httponly 属性: JavaScript から読み書きさせない
- [GOOGLE が使用している COOKIE の種類](https://policies.google.com/technologies/types?hl=ja)
  - 設定
    - NID という ID を保存し、この ID にユーザの設定情報(言語情報、位置情報、検索エンジンの設定など)が紐図いている
  - セッション管理
    - SID、HSID という名前に、アカウント ID や直近のログイン時刻などの情報が Cookie 上に暗号化されて保存されている
  - プロセス状態、セッション状態の管理
    - Google ドキュメントの複数タブでの同時利用や、Youtube での直近再生情報などの状態管理に利用している
  - 広告、アナリスティクス
    - ユーザ行動から関連広告を見せるような仕組みがある
    - \_\_ga というキーで ID を保存しており、匿名で利用動向を把握し解析するために利用される

## HTTP Headers

- Host
  - Resuest の Host ヘッダ(ユーザがどのドメインでアクセスしてきたか)を見て、予期しないホストでのアクセスを防ぐ
- X-Frame-Options: DENY
  - DENY に設定しておくと
- X-Content-Type-Options: nosniff
  - ブラウザがファイルを取得したときに、Content-Type の指定がない場合、ブラウザは自動でその Type を判定して処理しようとする
  - ドライブバイダウンロード攻撃の軽減対策になる
    - ウェブページなどを改ざんし、マルウェアなどの悪意あるコードをダウンロードさせて感染させる攻撃
- X-XSS-Protectiona: 1; mode=block
  - ブラウザが XSS 攻撃が検出したときに、レンダリングをやめる
