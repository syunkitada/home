# DHCP

- Dynamic Host Configuration Protocol
- ネットワーク接続するのに必要な情報を自動的に割り当てるアプリケーション層プロトコル
- UDP を使う
- DHCP はもともと BOOTP(BOOTstrap Protocol)がもとになっており、メッセージ構造などはほぼそのまま
  - BOOTP は単にクライアントに IP アドレスを通知するだけだったのに対して、DHCP では拡張部分を利用して、リース期間を設定したり、デフォルトゲートウェイの設定などもできる

## 目次

| Link                                          | Description |
| --------------------------------------------- | ----------- |
| [DHCP メッセージ](#DHCPメッセージ)            |             |
| [初回リース時のフロー](#初回リース時のフロー) |             |
| [リース延長時のフロー](#リース延長時のフロー) |             |
| [DHCP リレー](#DHCPリレー)                    |             |
| [DHCP の冗長化](#DHCPの冗長化)                |             |
| [参考](#参考)                                 |             |

## DHCP メッセージ

- DHCP では、DHCP メッセージを UDP でやり取りする
- ポート番号は、サーバ側が 67、クライアント側が 68
- メッセージのオプション部分に、タグ番号で示される様々な種類のデータを設定できる

| タグ値（10 進） | タグ名          | サイズ（オクテット） | 意味                                                                                   |
| --------------- | --------------- | -------------------- | -------------------------------------------------------------------------------------- |
| 1               | Subnet Mask     | 4                    | サブネット・マスク・アドレス                                                           |
| 3               | Router          | 可変                 | デフォルト・ゲートウェイ・アドレス                                                     |
| 6               | Domain Server   | 可変                 | DNS サーバ・アドレス                                                                   |
| 12              | Hostname        | 可変                 | クライアントのホスト名                                                                 |
| 15              | Domain Name     | 可変                 | DNS ドメイン名                                                                         |
| 50              | Address Request | 4                    | クライアントがリクエストする IP アドレス                                               |
| 51              | Address Time    | 4                    | IP アドレス・リース期間                                                                |
| 53              | DHCP Msg Type   | 1                    | DHCP メッセージ・タイプ                                                                |
| 54              | DHCP Server Id  | 4                    | DHCP サーバ・アドレス                                                                  |
| 56              | DHCP Message    | 可変                 | DHCP エラーメッセージ                                                                  |
| 58              | Renewal Time    | 4                    | クライアントがアドレスを取得してから Renewal（リースの再延長要求）するまでの期間（秒） |
| 59              | Rebinding Time  | 4                    | クライアントがアドレスを取得してから Rebinding するまでの期間（秒）                    |

- タグ「53」の DHCP Msg Type で、クライアント・サーバ間でメッセージ要求の意味を解釈している

| 値  | メッセージ名   | 意味                                                                                    |
| --- | -------------- | --------------------------------------------------------------------------------------- |
| 1   | DHCPDISCOVER   | クライアントがサーバを「発見」するためのメッセージ                                      |
| 2   | DHCPOFFER      | サーバからクライアントへの設定値「候補」を通知するメッセージ                            |
| 3   | DHCPREQUEST    | クライアントが決定したサーバへの取得依頼メッセージ                                      |
| 4   | DHCPDECLINE    | クライアントからサーバへの拒否（エラー）メッセージ                                      |
| 5   | DHCPACK        | サーバからクライアントへの取得正常終了メッセージ                                        |
| 6   | DHCPNAK        | サーバからクライアントへの取得拒否（エラー）メッセージ                                  |
| 7   | DHCPRELEASE    | クライアントからサーバへのリリース要求メッセージ                                        |
| 8   | DHCPINFORM     | IP アドレス取得は行わず、オプション取得のみ行う場合にクライアントから送られるメッセージ |
| 9   | DHCPFORCERENEW | サーバからクライアントへの再構成要求                                                    |

## 初回リース時のフロー

- DHCP クライアント: DHCP DISCOVER をブロードキャストで送信する
- DHCP サーバ: DHCP DISCOVER を受け取ったら、クライアントに対して DHCP OFFER(提案 IP を添えたレスポンス)を返す
- DHCP クライアント: 一番最初に受け取った DHCP OFFER で提案された IP を払い出してもらえるように、DHCP REQUEST をブロードキャストで送信する
- DHCP サーバ: サーバは要求に対して、IP の払い出しを承認する DHCP PACK を返す
  - もしダメであれば、DHCP PNAK を返す
- DHCP クライアント: PACK を受信したら IP アドレスなどの設定を行う
  - PNAK の場合は、DHCP DISCOVER からやり直しとなる

## リース延長時のフロー

- DHCP PNAK で、クライアントには Address Time(リース期間)のほかに、Renewal Time、Rebinding Time が通知される
- Renewal Time を過ぎるとクライアントは、IP の払い出したサーバにユニキャストで DHCP REQUEST を送信して、IP の延長(Renew)を行う
  - 一般的に Renewal Time は、Address Time の半分で設定される
  - Renew は成功するまで定期的に繰り返される
- Renew が失敗し続け、Rebinding Time を過ぎるとクライアントは、DHCP DISCOVER をブロードキャストで送信して、IP の再取得(Rebind)を行う
  - 一般的に Rebinding Time は、Address Time の 75%で設定される

## DHCP リレー

- DHCP を使うには同セグに DHCP サーバを設置する必要があるが、あるセグから他セグの DHCP サーバへ DHCP メッセージを仲介する「DHCP Relay」という仕組みがある
- DHCP Relay はルータがサポートしている場合が多い

## DHCP の冗長化

- pacemaker などでアクティブ・スタンバイの構成にする
- kubernetes などのオートヒールが可能なオーケストレーションツールを利用する
- 設定すべき mac アドレス、IP アドレスが分かってれば、DB などで管理して、まったく同じ払い出しをする DHCP サーバをどうセグに複数台立てる

## 参考

- http://www.atmarkit.co.jp/ait/articles/0202/26/news001.html
