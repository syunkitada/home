# TPM（Trusted Platform Module）

- TPM は、CPU 内もしくはマザーボード上のチップとして組み込まれたモジュールで、デバイス上で様々なセキュリティ機能を提供する
- TPM には、ディスクリート型の TPM とファームウェア TPM（fTPM）の２種類がある
  - ディスクリート型の TPM: マザーボード上に TPM モジュールを搭載して利用する
  - ファームウェア TPM(fTPM): チップセットや CPU 内の SoC に搭載された TPM 機能をマザーボード上のファームウェアと組み合わせて利用する
- TPM は、暗号化用アルゴリズムエンジン、ハッシュエンジン、鍵生成期、乱数生成期、不揮発性メモリ（鍵などを保存するため）などを備えている
- TPM には、1.2 と 2.0 が存在し、以下の違いがある
  - 2.0 では、暗号化アルゴリズムに ECC が利用可能になった
  - 1.2 では、鍵を管理するための階層が 1 階層だったが、2.0 では 3 階層になった
- TPM の利用例
  - Windows の BitLocker
    - Vista から利用できるようになった FDE（Full Disk Encryption）のソリューション
      - 万が一 PC が盗難されたり、ストレージそのものが盗難されても、ストレージは暗号化されているのでデータの気密性を保つことができる
      - ちなみに、Windows 11 では TPM 2.0 が必須となっており、TPM は BitLocker 以外でも利用されている
    - 仕組み
      - 正常起動時に、TPM とシステムファームウェアは互いに連携し、正常なシステムの起動時の測定値（コンピュータの UEFI/BIOS ファームウェアコードと構成、元のブートシーケンス、ブートコンポーネント、BCD 構成）を TPM に記録している
      - また、TPM にはディスクを暗号、複合化するための VMK（Volume Master Key）を格納している
      - TPM は、デバイスが起動する際に各種プロパティや、ブートシーケンスが変更されていないことを確認し、検証が成功すると TPM から VMK を CPU に送信し、ディスクの暗号化が解除されて OS の読み込みが開始される
        - 起動時に PC ログインとは別に、BitLocker 用のパスワードを設定することができ、これもまた PC 起動の条件とすることができる
      - 仮に、ハードウェアの構成を変更したり、USB など別の媒体からブートしようとすると、正常時に記録されていた際の値と、変更後で値が変わるため PC は起動できない
        - ハードウェアの構成は拡張や交換などで変更される可能性はあるため、どこまで厳密にチェックするかは設定可能

## TPM sniffing

- TPM sniffing はハードウェアの構成を変更せずに、ハードウェアをハックして TPM と CPU 間のデータを盗聴する攻撃方法
  - BitLocker は、TPM に VMK（Volume Master Key）を格納しているが、パスワードの設定がされてない場合はハードウェアの構成が変更されてない場合、通常起動できてしまう
    - しかし、通常はアカウントのログインパスワードが分からなければ PC へのログインはできないため、ストレージの中身を知ることは困難である
- 以下の記事では、LCP（Low Pin Count）バスから信号を盗聴することで、BitLocker で VMK を入手することに成功している
  - [SCRT Sec Team Blog: TPM sniffing](https://blog.scrt.ch/2021/11/15/tpm-sniffing/)
  - おそらく、パスワード設定を行っていない状態を想定したもの？

## コールドブート攻撃

- PC は、スリープ・サスペンド状態から再開させるために、メモリ内にハードディスク暗号化・複合化のキーを保存する場合がある
- このメモリを他のデバイスで読み、キーを入手するという攻撃手法
- TPM 上にキーを保存する場合は、この攻撃の難易度はかなり高くなる（不可能？）

## 参考

- [Windows 11 で必須になった「TPM 2.0」って何？TPM の役割や確認方法を紹介](https://pc.watch.impress.co.jp/docs/topic/feature/1334277.html)
- [SCRT Sec Team Blog: TPM sniffing](https://blog.scrt.ch/2021/11/15/tpm-sniffing/)
