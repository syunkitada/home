# 仮想通貨


## Bitcoinの仕組み
* 大本は論文
    * Bitcoin: A Peer-to-Peer Electronic Cash System
    * Satoshi Nakamoto（中本 哲史）（2008）
* Bitcoinとは厳密には仮想通貨ではなく、通貨取引システム
    * その中でやる取りされる仮想通貨の単位を1Bitcoinと呼んでいる
* BitcoinはOSS
    * OSSなので中での取引や、通貨の管理の仕方がすべてオープンになってる
* 中央管理者はおらず、ネットワークに参加しているノード達によって元帳(取引履歴)が管理される
* ユーザは自分のアドレス(口座)を用意するが、これは誰かに申請するのではなく、勝手に作成してよい
    * ユーザは秘密鍵と公開鍵のペアを作り、この公開鍵がアドレスとなる
    * これは全世界でユニークであり何個持ってもいい
* 自分のアドレスから、他人のアドレスに送金したい場合、
    * 自分の秘密鍵を使って、送金リクエストをネットワーク上に流すことができる
    * ネットワーク上には送金リクエストのプールがあり、そこにいったん保存される
    * この時、送金リクエストに手数料を付けてもいいし、付けなくてもよい
* 元帳への書き込み
    * 暗号バトルに勝者したものが元帳への書き込みの権利を得る
        * 暗号バトルとはお題が出て、参加ノードはハッシュを生成して、それをひたすらお題に当てはめて正解を探している
            * 参加ノードが多ければ、このバトルに勝つのは難しいし、また、ACICなどを導入した強い参加者がいると、当然これも勝つのは難しい
            * このお題の難易度も参加者の人数によって変わり、参加者が多ければ難しくなる
        * 誰かが正解すると、それを他のノードが本当に正解かを投票し、51%以上が認めると、元帳への書き込みの権利を得る
        * もし、勝者が二人以上出てしまったら
            * タイミングによっては勝者が二人以上出ることがある
            * すると、ネットワークが分裂し(これをフォークする)、それぞれのネットワークでトランザクションが進む
            * しかし、何トランザクションか進むと、差分が出てくるので、その時元帳が長いほうが正しい元帳と判断され、そうでない場合は破棄される
    * リクエストはプールから拾われて一定量束てて、元帳に書き込む
        * この単位がトランザクション
    * 一定量しか束ねられないので、手数料が高いものが優先的に拾われる
    * 一定時間放置されたリクエストもトランザクションに一定量含ませなければならないので、手数料がなくても一定時間たてば処理される
* 新規発行コイン
    * 新規発行コインは、元帳へ書き込んだノードに対して、報酬として支払われる
    * しかし、無限に新規発行コインを作ると、価値が暴落してしまうので、一定年ごとに新規発行コインを減らしている
    * 2015年 25BTC支払われているものが、2017年には12.5BTCに半減、そして2021年にはそれが6.25BTCになる
    * 報酬が下げているは、ビットコインの流通量を減らして、年を増すごとに「採掘インセンティブ重視」から「送金手数料（トランザクション・フィー）インセンティブ重視」の、より純粋な決済ネットワークへとシフトしていくためである
* ブロックチェーンと仮想通貨の元帳
    * ブロックチェーンとはP2Pで元帳を分散管理する技術
    * 元帳のページがブロックで、元帳がブロックチェーン
* ノードの採算について
    * ノードの報酬は、元帳へ書き込む際の新規発行コインと、送金手数料である
    * 他の参加者ノードに勝てないとこの収入を得られるチャンスが減る
    * 電気代や機器の維持費と比較して採算が取れるなら良し、そうでないなら参加すべきではない
        * 参加者が多かったり、ASICなどを導入してマイニングされてるようなコインは採算がとりずらくなっている
        * 国や地域によって電気代が安い高いがあるので、その条件によって有利不利もある
    * とはいえ、採算がとれなくなってしまうとコイン自体が破綻してしまうので、採算の取れるように、参加ノードが減ったり、手数料が上げられたりでどこかに落ち着くはず
* 現金化について
    * コインを現金や物品と取引する業者がいる
        * このため、コインに金銭的な価値が生まれて取引が成り立っている
    * 取引は取引所でアカウントとアドレスを作成することでできる
        * またこのアドレスで通貨を掘ることでお金を稼げる
        * 公開鍵(アドレス)と秘密鍵は取引所で管理されている
            * たまにニュースであるが、ここがハッキングされて秘密鍵を盗まれるとコインも送金されて盗まれる
    * 取引所
        * bitflyer
            * 大手
            * メジャーコインを扱うならここ
        * conincheck
            * 中堅
            * マイナーコインもある
        * zaif
            * 中堅


## Etheriumの掘り方
### アドレスの準備
やり方は2通り
* 個人で作成する
    * 以下のコマンドで作成できる
        * $ geth account new
    * 以下のようなアドレス(公開鍵)が出力されるので、このアドレスを掘るときに利用する
        * 3f01b267f52f8204a9fcd6ff2ca6711f509c7542
    * ローカルで管理しているaccountの一覧は以下で確認できる
    * 秘密鍵の場所もここに書かれている
        * geth account list
* bitflyerなどの取引所でアドレスを作成する（現金化するならこっち)
    * このアドレスを掘るときに利用する

### etheminerを実行するまで
* 環境は、Ubuntu16、GPX1060
* cudaのインストール
```
sudo apt-key adv --fetch-keys http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1604/x86_64/7fa2af80.pub
wget http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1604/x86_64/cuda-repo-ubuntu1604_9.0.176-1_amd64.deb
sudo dpkg -i cuda-repo-ubuntu1604_9.0.176-1_amd64.deb
sudo apt update
sudo apt install cuda cuda-drivers

sudo reboot
```

* ethminerをダウンロードして以下を実行
```
$ ./ethminer --farm-recheck 200 -U -S asia1.ethermine.org:4444 -FS asia1.ethermine.org:14444 -O [your address]


### おまけ: pinningしてみた
```
# isolの設定
$ sudo vim /etc/default/grub
GRUB_CMDLINE_LINUX="isolcpus=1"

$ sudo grub-mkconfig -o /boot/grub/grub.cfg
$ sudo reboot

$ cat /proc/cmdline
BOOT_IMAGE=/boot/vmlinuz-4.4.0-59-generic root=UUID=c5a29305-9548-4405-a4d2-5687eda29d87 ro isolcpus=1 quiet splash vt.handoff=7


# tasksetでisolしたコアにpinningして実行
$ taskset -c 1 ./ethminer --farm-recheck 200 -U -S asia1.ethermine.org:4444 -FS asia1.ethermine.org:14444 -O [your address]

# pinningの確認
$ ps ax | grep eth
2875 pts/1    Sl+    0:02 ./ethminer --farm-recheck 200 -U -S asia1.ethermine.org:4444 -FS asia1.ethermine.org:14444 -O xxxx
$ cat /proc/2875/status | grep Cpus
Cpus_allowed:   2
Cpus_allowed_list:      1
```


## モニタリング
* 基本的にGPUが100%張り付いてて、その他のリソースはほとんど使われない
```
# cpuの温度を見る
$ watch -n 10 cat /sys/class/thermal/thermal_zone0/temp

# GPUの利用率、温度を見る
$ watch -n 10 nvidia-smi

# メモリを見る
$ vmstat 1

# CPUを見る
$ mpstat -P ALL 1

# プロセスを見る
$ pidstat 1 -r -u -p [etheminer pid]
```
